<html>
  <head>
    <title>今日のアニメ</title>
    <meta property="og:url" content="http://cympfh.cc/anime">
    <meta property="og:title" content="今日のアニメ" />
    <meta property="og:description" content="cympfh.cc/anime" />
    <meta property="og:image" content="http://cympfh.cc/resources/img/identicon.png" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@cympfh" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- dev
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    -->
    <!-- prod
    -->
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  </head>
  <body>

    <div class="section">
      <section class="hero">
        <div class="hero-body">
          <div class="container">
            <h1 class="title">Today's Your Anime</h1>
            <p class="has-text-right">
            <span class="socialshare">
              <a href="https://twitter.com/share" class="twitter-share-button" data-text="Today's Your Anime" data-size="large" data-count="none">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
            </span>
            </p>
          </div>
        </div>
      </section>
    </div>

    <div class="section">
      <div class="container">

        <div class="tabs">
          <ul>
            <li class="is-active"><a>Anime Graph</a></li>
            <li><a href="/anime/recommend">Recommend</a></li>
          </ul>
        </div>

        <div class="columns">

          <div class="column is-one-third">
            <div id="gacha">

              <div class="container has-text-right">
                <a href="/anime"><i class="fa fa-refresh" aria-hidden="true"></i>&nbsp;Random</a>
              </div>

              <h2 class="subtitle">
                <a v-bind:href="'https://annict.jp/works/' + annictId">
                  {{ title }}
                  <i class="fa fa-plane" aria-hidden="true"></i></a>
              </h2>


              <aside class="menu">
                <p class="menu-label">10 Relatives</p>
                <ul class="menu-list" v-for="anime in relatives">
                  <li>
                    <a v-bind:href="'/anime/' + anime['annictId']">{{ anime["title"] }}</a>
                  </li>
                </ul>
              </aside>

            </div>
          </div>

          <div class="column">
            <div id="graph"></div>
          </div>

        </div>
      </div>
    </div>

    <script>
      var annict_id = location.href.replace(/\?.*/g, '').replace(/#.*/g, '').split('/').pop();

      var gacha = new Vue({
        el: '#gacha',
        data: {
          title: "",
          annictId: annict_id,
          relatives: []
        },
        created() {
          fetch(`http://localhost:8080/anime/api/info?annict_id=${annict_id}`)
            .then(response => response.json())
            .then(json => {
              this.title = json["title"];
              this.annictId = json["annictId"];
              this.relatives = json["relatives"];
            });
        }
      })
    </script>

    <script type="text/javascript">
      var degree_first = 6;
      var degree_second = 4;
      var graph = new Vue({
        el: '#graph',
        data: {
          used_node_ids: new Set(),
          used_edged: new Set(),
          data: {
            nodes: new vis.DataSet([]),
            edges: new vis.DataSet([]),
          },
          options: {
            width: '100%',
            height: '100%'
          }
        },
        created() {

          var addNode = (annict_id, title) => {
            if (!this.used_node_ids.has(annict_id)) {
              this.used_node_ids.add(annict_id);
              this.data.nodes._addItem({id: annict_id, label: title});
            }
          }

          var addEdge = (id1, id2) => {
          if (id1 > id2) return addEdge(id2, id1);
            var hashkey = id1 * 99999 + id2;
            var edge = {from: id1, to: id2};
            if (!this.used_edged.has(hashkey)) {
              this.used_edged.add(hashkey);
              this.data.edges._addItem(edge)
            }
          }

          fetch(`http://localhost:8080/anime/api/info?annict_id=${annict_id}`)
            .then(response => response.json())
            .then(json => {

              var container = document.getElementById('graph');

              var aid = json["annictId"] | 0;
              addNode(aid, json['title']);

              for (var child of json["relatives"].slice(0, degree_first)) {
                var cid = child["annictId"] | 0;
                addNode(cid, child['title']);
                addEdge(aid, cid);
              }
              var network = new vis.Network(container, this.data, this.options);

              for (var child of json["relatives"].slice(0, degree_first)) {
                fetch(`http://localhost:8080/anime/api/info?annict_id=${child['annictId']}`)
                  .then(response => response.json())
                  .then(json => {
                    var aid = json["annictId"] | 0;
                    for (var child of json["relatives"].slice(0, degree_second)) {
                      var cid = child["annictId"] | 0;
                      addNode(cid, child['title']);
                      addEdge(aid, cid);
                    }
                    network = new vis.Network(container, this.data, this.options);
                    network.on('doubleClick', (e) => {
                      if (e.nodes[0]) {
                        location.href = `/anime/${e.nodes[0]}`;
                      }
                    });
                  });
              }
            });
        }
      });
    </script>

  </body>
</html>
